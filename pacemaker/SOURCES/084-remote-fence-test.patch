From 201d058a6df884ddab4d83d482203e0ef7044d21 Mon Sep 17 00:00:00 2001
From: Ken Gaillot <kgaillot@redhat.com>
Date: Wed, 5 Jul 2017 18:03:14 -0500
Subject: [PATCH] Test: pengine: update remote-fence-unclean-3 regression test

---
 pengine/test10/remote-fence-unclean-3.dot     | 22 ++-----
 pengine/test10/remote-fence-unclean-3.exp     | 95 +++++++--------------------
 pengine/test10/remote-fence-unclean-3.scores  |  4 --
 pengine/test10/remote-fence-unclean-3.summary | 15 ++---
 4 files changed, 34 insertions(+), 102 deletions(-)

diff --git a/pengine/test10/remote-fence-unclean-3.dot b/pengine/test10/remote-fence-unclean-3.dot
index 11d1208..b32b77e 100644
--- a/pengine/test10/remote-fence-unclean-3.dot
+++ b/pengine/test10/remote-fence-unclean-3.dot
@@ -1,27 +1,19 @@
 digraph "g" {
-"all_stopped" -> "fence1_start_0 overcloud-controller-1" [ style = bold]
+"all_stopped" -> "fence1_start_0 overcloud-controller-0" [ style = bold]
 "all_stopped" [ style=bold color="green" fontcolor="orange"]
-"fence1_monitor_0 overcloud-controller-0" -> "fence1_start_0 overcloud-controller-1" [ style = bold]
+"fence1_monitor_0 overcloud-controller-0" -> "fence1_start_0 overcloud-controller-0" [ style = bold]
 "fence1_monitor_0 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
-"fence1_monitor_0 overcloud-controller-1" -> "fence1_start_0 overcloud-controller-1" [ style = bold]
+"fence1_monitor_0 overcloud-controller-1" -> "fence1_start_0 overcloud-controller-0" [ style = bold]
 "fence1_monitor_0 overcloud-controller-1" [ style=bold color="green" fontcolor="black"]
-"fence1_monitor_0 overcloud-controller-2" -> "fence1_start_0 overcloud-controller-1" [ style = bold]
+"fence1_monitor_0 overcloud-controller-2" -> "fence1_start_0 overcloud-controller-0" [ style = bold]
 "fence1_monitor_0 overcloud-controller-2" [ style=bold color="green" fontcolor="black"]
-"fence1_monitor_60000 overcloud-controller-1" [ style=bold color="green" fontcolor="black"]
-"fence1_start_0 overcloud-controller-1" -> "fence1_monitor_60000 overcloud-controller-1" [ style = bold]
-"fence1_start_0 overcloud-controller-1" [ style=bold color="green" fontcolor="black"]
-"foo_monitor_0 overcloud-controller-0" -> "foo_start_0 overcloud-controller-0" [ style = bold]
-"foo_monitor_0 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
-"foo_monitor_0 overcloud-controller-1" -> "foo_start_0 overcloud-controller-0" [ style = bold]
-"foo_monitor_0 overcloud-controller-1" [ style=bold color="green" fontcolor="black"]
-"foo_monitor_0 overcloud-controller-2" -> "foo_start_0 overcloud-controller-0" [ style = bold]
-"foo_monitor_0 overcloud-controller-2" [ style=bold color="green" fontcolor="black"]
-"foo_start_0 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
+"fence1_monitor_60000 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
+"fence1_start_0 overcloud-controller-0" -> "fence1_monitor_60000 overcloud-controller-0" [ style = bold]
+"fence1_start_0 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
 "overcloud-novacompute-0_stop_0 overcloud-controller-0" -> "all_stopped" [ style = bold]
 "overcloud-novacompute-0_stop_0 overcloud-controller-0" [ style=bold color="green" fontcolor="black"]
 "stonith 'reboot' overcloud-novacompute-0" -> "stonith_complete" [ style = bold]
 "stonith 'reboot' overcloud-novacompute-0" [ style=bold color="green" fontcolor="black"]
 "stonith_complete" -> "all_stopped" [ style = bold]
-"stonith_complete" -> "foo_start_0 overcloud-controller-0" [ style = bold]
 "stonith_complete" [ style=bold color="green" fontcolor="orange"]
 }
diff --git a/pengine/test10/remote-fence-unclean-3.exp b/pengine/test10/remote-fence-unclean-3.exp
index 14e1b0b..2e341bd 100644
--- a/pengine/test10/remote-fence-unclean-3.exp
+++ b/pengine/test10/remote-fence-unclean-3.exp
@@ -1,71 +1,22 @@
 <transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY"  transition_id="0">
   <synapse id="0">
     <action_set>
-      <rsc_op id="49" operation="start" operation_key="foo_start_0" on_node="overcloud-controller-0" on_node_uuid="1">
-        <primitive id="foo" class="ocf" provider="heartbeat" type="Dummy"/>
-        <attributes CRM_meta_on_node="overcloud-controller-0" CRM_meta_on_node_uuid="1" CRM_meta_timeout="20000" />
-      </rsc_op>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="43" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="45" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="47" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="188" operation="stonith_complete" operation_key="stonith_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="1">
-    <action_set>
-      <rsc_op id="47" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3">
-        <primitive id="foo" class="ocf" provider="heartbeat" type="Dummy"/>
-        <attributes CRM_meta_on_node="overcloud-controller-2" CRM_meta_on_node_uuid="3" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" />
-      </rsc_op>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="2">
-    <action_set>
-      <rsc_op id="45" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2">
-        <primitive id="foo" class="ocf" provider="heartbeat" type="Dummy"/>
-        <attributes CRM_meta_on_node="overcloud-controller-1" CRM_meta_on_node_uuid="2" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" />
-      </rsc_op>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="3">
-    <action_set>
-      <rsc_op id="43" operation="monitor" operation_key="foo_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1">
-        <primitive id="foo" class="ocf" provider="heartbeat" type="Dummy"/>
-        <attributes CRM_meta_on_node="overcloud-controller-0" CRM_meta_on_node_uuid="1" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" />
-      </rsc_op>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="4">
-    <action_set>
-      <rsc_op id="51" operation="monitor" operation_key="fence1_monitor_60000" on_node="overcloud-controller-1" on_node_uuid="2">
+      <rsc_op id="47" operation="monitor" operation_key="fence1_monitor_60000" on_node="overcloud-controller-0" on_node_uuid="1">
         <primitive id="fence1" class="stonith" type="fence_xvm"/>
-        <attributes CRM_meta_interval="60000" CRM_meta_name="monitor" CRM_meta_on_node="overcloud-controller-1" CRM_meta_on_node_uuid="2" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
+        <attributes CRM_meta_interval="60000" CRM_meta_name="monitor" CRM_meta_on_node="overcloud-controller-0" CRM_meta_on_node_uuid="1" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="50" operation="start" operation_key="fence1_start_0" on_node="overcloud-controller-1" on_node_uuid="2"/>
+        <rsc_op id="46" operation="start" operation_key="fence1_start_0" on_node="overcloud-controller-0" on_node_uuid="1"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="5">
+  <synapse id="1">
     <action_set>
-      <rsc_op id="50" operation="start" operation_key="fence1_start_0" on_node="overcloud-controller-1" on_node_uuid="2">
+      <rsc_op id="46" operation="start" operation_key="fence1_start_0" on_node="overcloud-controller-0" on_node_uuid="1">
         <primitive id="fence1" class="stonith" type="fence_xvm"/>
-        <attributes CRM_meta_on_node="overcloud-controller-1" CRM_meta_on_node_uuid="2" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
+        <attributes CRM_meta_on_node="overcloud-controller-0" CRM_meta_on_node_uuid="1" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
@@ -73,44 +24,44 @@
         <pseudo_event id="42" operation="all_stopped" operation_key="all_stopped"/>
       </trigger>
       <trigger>
-        <rsc_op id="44" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1"/>
+        <rsc_op id="43" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1"/>
       </trigger>
       <trigger>
-        <rsc_op id="46" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2"/>
+        <rsc_op id="44" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2"/>
       </trigger>
       <trigger>
-        <rsc_op id="48" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3"/>
+        <rsc_op id="45" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="6">
+  <synapse id="2">
     <action_set>
-      <rsc_op id="48" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3">
+      <rsc_op id="45" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-2" on_node_uuid="3">
         <primitive id="fence1" class="stonith" type="fence_xvm"/>
         <attributes CRM_meta_on_node="overcloud-controller-2" CRM_meta_on_node_uuid="3" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
       </rsc_op>
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="7">
+  <synapse id="3">
     <action_set>
-      <rsc_op id="46" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2">
+      <rsc_op id="44" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-1" on_node_uuid="2">
         <primitive id="fence1" class="stonith" type="fence_xvm"/>
         <attributes CRM_meta_on_node="overcloud-controller-1" CRM_meta_on_node_uuid="2" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
       </rsc_op>
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="8">
+  <synapse id="4">
     <action_set>
-      <rsc_op id="44" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1">
+      <rsc_op id="43" operation="monitor" operation_key="fence1_monitor_0" on_node="overcloud-controller-0" on_node_uuid="1">
         <primitive id="fence1" class="stonith" type="fence_xvm"/>
         <attributes CRM_meta_on_node="overcloud-controller-0" CRM_meta_on_node_uuid="1" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000"  multicast_address="225.0.0.2"/>
       </rsc_op>
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="9">
+  <synapse id="5">
     <action_set>
       <rsc_op id="30" operation="stop" operation_key="overcloud-novacompute-0_stop_0" on_node="overcloud-controller-0" on_node_uuid="1">
         <primitive id="overcloud-novacompute-0" class="ocf" provider="pacemaker" type="remote"/>
@@ -122,9 +73,9 @@
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="10">
+  <synapse id="6">
     <action_set>
-      <crm_event id="189" operation="stonith" operation_key="stonith-overcloud-novacompute-0-reboot" on_node="overcloud-novacompute-0" on_node_uuid="overcloud-novacompute-0">
+      <crm_event id="185" operation="stonith" operation_key="stonith-overcloud-novacompute-0-reboot" on_node="overcloud-novacompute-0" on_node_uuid="overcloud-novacompute-0">
         <attributes CRM_meta_compute_role="true" CRM_meta_on_node="overcloud-novacompute-0" CRM_meta_on_node_uuid="overcloud-novacompute-0" CRM_meta_stonith_action="reboot" />
         <downed>
           <node id="overcloud-novacompute-0"/>
@@ -133,19 +84,19 @@
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="11">
+  <synapse id="7">
     <action_set>
-      <pseudo_event id="188" operation="stonith_complete" operation_key="stonith_complete">
+      <pseudo_event id="184" operation="stonith_complete" operation_key="stonith_complete">
         <attributes />
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <crm_event id="189" operation="stonith" operation_key="stonith-overcloud-novacompute-0-reboot" on_node="overcloud-novacompute-0" on_node_uuid="overcloud-novacompute-0"/>
+        <crm_event id="185" operation="stonith" operation_key="stonith-overcloud-novacompute-0-reboot" on_node="overcloud-novacompute-0" on_node_uuid="overcloud-novacompute-0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="12">
+  <synapse id="8">
     <action_set>
       <pseudo_event id="42" operation="all_stopped" operation_key="all_stopped">
         <attributes />
@@ -156,7 +107,7 @@
         <rsc_op id="30" operation="stop" operation_key="overcloud-novacompute-0_stop_0" on_node="overcloud-controller-0" on_node_uuid="1"/>
       </trigger>
       <trigger>
-        <pseudo_event id="188" operation="stonith_complete" operation_key="stonith_complete"/>
+        <pseudo_event id="184" operation="stonith_complete" operation_key="stonith_complete"/>
       </trigger>
     </inputs>
   </synapse>
diff --git a/pengine/test10/remote-fence-unclean-3.scores b/pengine/test10/remote-fence-unclean-3.scores
index 0284218..24bdcf9 100644
--- a/pengine/test10/remote-fence-unclean-3.scores
+++ b/pengine/test10/remote-fence-unclean-3.scores
@@ -872,10 +872,6 @@ native_color: fence1 allocation score on overcloud-controller-0: 0
 native_color: fence1 allocation score on overcloud-controller-1: 0
 native_color: fence1 allocation score on overcloud-controller-2: 0
 native_color: fence1 allocation score on overcloud-novacompute-0: -INFINITY
-native_color: foo allocation score on overcloud-controller-0: 0
-native_color: foo allocation score on overcloud-controller-1: 0
-native_color: foo allocation score on overcloud-controller-2: 0
-native_color: foo allocation score on overcloud-novacompute-0: 0
 native_color: galera-bundle-0 allocation score on galera-bundle-0: -INFINITY
 native_color: galera-bundle-0 allocation score on galera-bundle-1: -INFINITY
 native_color: galera-bundle-0 allocation score on galera-bundle-2: -INFINITY
diff --git a/pengine/test10/remote-fence-unclean-3.summary b/pengine/test10/remote-fence-unclean-3.summary
index cc60ebe..ec24500 100644
--- a/pengine/test10/remote-fence-unclean-3.summary
+++ b/pengine/test10/remote-fence-unclean-3.summary
@@ -4,7 +4,6 @@ Online: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]
 RemoteOFFLINE: [ overcloud-novacompute-0 ]
 Containers: [ galera-bundle-0:galera-bundle-docker-0 galera-bundle-1:galera-bundle-docker-1 galera-bundle-2:galera-bundle-docker-2 rabbitmq-bundle-0:rabbitmq-bundle-docker-0 rabbitmq-bundle-1:rabbitmq-bundle-docker-1 rabbitmq-bundle-2:rabbitmq-bundle-docker-2 redis-bundle-0:redis-bundle-docker-0 redis-bundle-1:redis-bundle-docker-1 redis-bundle-2:redis-bundle-docker-2 ]
 
- foo	(ocf::heartbeat:Dummy):	Stopped
  fence1	(stonith:fence_xvm):	Stopped
  overcloud-novacompute-0	(ocf::pacemaker:remote):	FAILED overcloud-controller-0
  Docker container set: rabbitmq-bundle [192.168.24.1:8787/tripleoupstream/centos-binary-rabbitmq:latest]
@@ -36,14 +35,10 @@ Containers: [ galera-bundle-0:galera-bundle-docker-0 galera-bundle-1:galera-bund
 
 Transition Summary:
  * Fence overcloud-novacompute-0
- * Start   foo	(overcloud-controller-0)
- * Start   fence1	(overcloud-controller-1)
+ * Start   fence1	(overcloud-controller-0)
  * Stop    overcloud-novacompute-0	(overcloud-controller-0)
 
 Executing cluster transition:
- * Resource action: foo             monitor on overcloud-controller-2
- * Resource action: foo             monitor on overcloud-controller-1
- * Resource action: foo             monitor on overcloud-controller-0
  * Resource action: fence1          monitor on overcloud-controller-2
  * Resource action: fence1          monitor on overcloud-controller-1
  * Resource action: fence1          monitor on overcloud-controller-0
@@ -51,17 +46,15 @@ Executing cluster transition:
  * Fencing overcloud-novacompute-0 (reboot)
  * Pseudo action:   stonith_complete
  * Pseudo action:   all_stopped
- * Resource action: foo             start on overcloud-controller-0
- * Resource action: fence1          start on overcloud-controller-1
- * Resource action: fence1          monitor=60000 on overcloud-controller-1
+ * Resource action: fence1          start on overcloud-controller-0
+ * Resource action: fence1          monitor=60000 on overcloud-controller-0
 
 Revised cluster status:
 Online: [ overcloud-controller-0 overcloud-controller-1 overcloud-controller-2 ]
 RemoteOFFLINE: [ overcloud-novacompute-0 ]
 Containers: [ galera-bundle-0:galera-bundle-docker-0 galera-bundle-1:galera-bundle-docker-1 galera-bundle-2:galera-bundle-docker-2 rabbitmq-bundle-0:rabbitmq-bundle-docker-0 rabbitmq-bundle-1:rabbitmq-bundle-docker-1 rabbitmq-bundle-2:rabbitmq-bundle-docker-2 redis-bundle-0:redis-bundle-docker-0 redis-bundle-1:redis-bundle-docker-1 redis-bundle-2:redis-bundle-docker-2 ]
 
- foo	(ocf::heartbeat:Dummy):	Started overcloud-controller-0
- fence1	(stonith:fence_xvm):	Started overcloud-controller-1
+ fence1	(stonith:fence_xvm):	Started overcloud-controller-0
  overcloud-novacompute-0	(ocf::pacemaker:remote):	Stopped
  Docker container set: rabbitmq-bundle [192.168.24.1:8787/tripleoupstream/centos-binary-rabbitmq:latest]
    rabbitmq-bundle-0	(ocf::heartbeat:rabbitmq-cluster):	Started overcloud-controller-0
-- 
1.8.3.1

